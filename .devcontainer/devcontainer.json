{
  "build": {
    "context": ".",
    "dockerfile": "./Dockerfile",
    "args": {
      "CUDA": "11.8"
    }
  },

  "capAdd": [
    "SYS_PTRACE"
  ],
  "securityOpt": [
    "seccomp=unconfined"
  ],
  "hostRequirements": {
    "gpu": true
  },

  "initializeCommand": "mkdir -p ../.aws ../.cache ../.cargo ../.conda ../.config ../legion ../legate",

  "containerEnv": {
    "DEFAULT_CONDA_ENV": "legate",
    "PYTHONDONTWRITEBYTECODE": "1",
    "VAULT_HOST": "https://vault.ops.k8s.rapids.ai"
  },

  "workspaceFolder": "/home/coder",
  "workspaceMount": "source=${localWorkspaceFolder},target=/home/coder/cunumeric,type=bind",
  "mounts": [
    {
      "type": "bind",
      "target": "/home/coder/.aws",
      "source": "${localWorkspaceFolder}/../.aws"
    },
    {
      "type": "bind",
      "target": "/home/coder/.cache",
      "source": "${localWorkspaceFolder}/../.cache"
    },
    {
      "type": "bind",
      "target": "/home/coder/.cargo",
      "source": "${localWorkspaceFolder}/../.cargo"
    },
    {
      "type": "bind",
      "target": "/home/coder/.conda",
      "source": "${localWorkspaceFolder}/../.conda"
    },
    {
      "type": "bind",
      "target": "/home/coder/.config",
      "source": "${localWorkspaceFolder}/../.config"
    },
    {
      "type": "bind",
      "target": "/home/coder/legion",
      "source": "${localWorkspaceFolder}/../legion"
    },
    {
      "type": "bind",
      "target": "/home/coder/legate",
      "source": "${localWorkspaceFolder}/../legate"
    },
    {
      "type": "bind",
      "target": "/opt/legate",
      "source": "${localWorkspaceFolder}/.devcontainer/opt/legate"
    },
    {
      "type": "bind",
      "target": "/home/coder/workspace.code-workspace",
      "source": "${localWorkspaceFolder}/.devcontainer/home/coder/workspace.code-workspace"
    }
  ],

  "customizations": {
    "vscode": {
      "extensions": [
        "cschlosser.doxdocgen",
        "llvm-vs-code-extensions.vscode-clangd",
        "mutantdino.resourcemonitor",
        "ms-vscode.cpptools",
        "rust-lang.rust-analyzer",
        "serayuzgur.crates",
        "tamasfe.even-better-toml",
        "vadimcn.vscode-lldb",
        "xaver.clang-format"
      ],
      "settings": {
        "C_Cpp.vcpkg.enabled": false,
        "C_Cpp.formatting": "disabled",
        "C_Cpp.autocomplete": "disabled",
        "C_Cpp.errorSquiggles": "disabled",
        "C_Cpp.intelliSenseEngine": "disabled",
        "C_Cpp.configurationWarnings": "disabled",
        "C_Cpp.autoAddFileAssociations": false,
        "clang-format.fallbackStyle": "none",
        "clangd.arguments": [
          "--log=info",
          "--clang-tidy",
          "--debug-origin",
          "--pch-storage=disk",
          "--use-dirty-headers",
          "--background-index=true",
          "--all-scopes-completion",
          "--header-insertion=iwyu",
          "--completion-parse=always",
          "--completion-style=detailed",
          "--header-insertion-decorators"
        ],
        "files.trimFinalNewlines": true,
        "files.insertFinalNewline": true,
        "files.trimTrailingWhitespace": true,
        "files.watcherExclude": {
          "**/target/**": true
        },
        "python.linting.flake8Enabled": true,
        "rust-analyzer.checkOnSave": true,
        "rust-analyzer.check.command": "clippy",
        "[c]": {
          "editor.defaultFormatter": "xaver.clang-format"
        },
        "[cpp]": {
          "editor.defaultFormatter": "xaver.clang-format"
        },
        "[cuda-cpp]": {
          "editor.defaultFormatter": "xaver.clang-format"
        }
      }
    }
  },

  // This is defined in the base image already, but we
  // need to define it again to work around codespaces bug
  "postAttachCommand": [
    "bash",
    "-li",
    "+o",
    "history",
    "/opt/devcontainer/bin/post-attach-command.sh"
  ]
}
